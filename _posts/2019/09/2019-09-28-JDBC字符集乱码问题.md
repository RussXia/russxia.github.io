---
layout: blog
title: "JDBCå­—ç¬¦é›†ä¹±ç é—®é¢˜"
catalog: true
tag: [Java,è¸©å‘,2019]
---
# JDBCå­—ç¬¦é›†ä¹±ç é—®é¢˜

## é—®é¢˜èƒŒæ™¯

> æ•°æ®åº“:mysql 5.7
>
> datasourceæ•°æ®æº:druid
>
> Connector/J: 5.1.38

å…¬å¸çº¿ä¸ŠæŠ¥è­¦ï¼Œå‘ç°æŠ›å‡º `UncategorizedSQLException` å¼‚å¸¸ï¼Œçœ‹åˆ°å¼‚å¸¸æ ˆçš„ä¿¡æ¯ï¼ŒåŸºæœ¬å¯ä»¥æ–­å®šæ˜¯å­—ç¬¦é›†è®¾ç½®çš„é—®é¢˜ã€‚
```
Cause: java.sql.SQLException: Incorrect string value: '\xF0\x9F\x87\xA8\xF0\x9F...' for column 'nick_name' at row 1; uncategorized SQLException for SQL []; SQL state [HY000]; error code [1366]; Incorrect string value: '\xF0\x9F\x87\xA8\xF0\x9F...' for column 'nick_name' at row 1; nested exception is java.sql.SQLException: Incorrect string value: '\xF0\x9F\x87\xA8\xF0\x9F...' for column 'nick_name' at row 1
    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:84)
    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)
    at org.springframework.jdbc.support.AbstractFallbackSQLExceptionTranslator.translate(AbstractFallbackSQLExceptionTranslator.java:81)
```
ä½†æ˜¯åœ¨æŸ¥çœ‹äº†çº¿ä¸Šæ•°æ®åº“å¯¹åº”è¡¨çš„å­—ç¬¦ç¼–ç æ ¼å¼åï¼Œå‘ç°è®¾ç½®çš„æ˜¯utfmb4ã€‚è€Œä¸”æµ‹è¯•ç¯å¢ƒè®¾ç½®çš„ä¹Ÿæ˜¯utfmb4ï¼Œå¹¶æ²¡æœ‰å‡ºç° `UncategorizedSQLException` å¼‚å¸¸ï¼Œæ­£å¸¸æ’å…¥äº†emojiè¡¨æƒ…ç¬¦å·ã€‚


## é—®é¢˜æ’æŸ¥
æ€€ç–‘çº¿ä¸Šåº“å’Œæµ‹è¯•åº“å¯èƒ½å­—ç¬¦é›†è®¾ç½®ä¸Šå­˜åœ¨å·®å¼‚ï¼Œ`SHOW VARIABLES LIKE "character_set%";` æŸ¥çœ‹å­—ç¬¦é›†è®¾ç½®ã€‚

æµ‹è¯•ç¯å¢ƒå­—ç¬¦é›†è®¾ç½®:

```
character_set_client	utf8mb4
character_set_connection	utf8mb4
character_set_database	utf8mb4
character_set_filesystem	binary
character_set_results	utf8mb4
character_set_server	utf8mb4
character_set_system	utf8
```

çº¿ä¸Šç¯å¢ƒå­—ç¬¦é›†è®¾ç½®:
```
character_set_client	utf8
character_set_connection	utf8
character_set_database	utf8mb4
character_set_filesystem	binary
character_set_results	utf8
character_set_server	utf8
character_set_system	utf8
```
æœç„¶äºŒè€…çš„å­—ç¬¦é…ç½®ä¸ä¸€æ ·ã€‚æ­¤æ—¶æˆ‘æƒ³å½“ç„¶çš„è®¤ä¸ºæ˜¯çº¿ä¸Š `character_set_connection` ç¼–ç æ ¼å¼æ˜¯ `utf8` å¯¼è‡´çš„ã€‚ä½†æ˜¯åœ¨æœ¬åœ°æµ‹è¯•äº†ä¸‹ï¼Œå°†çº¿ä¸Šçš„å­—ç¬¦é›†é…ç½®è®¾ç½®åˆ°æœ¬åœ°ï¼Œç„¶è€Œå°† `character_set_connection` è®¾ç½®ä¸º `utf8mb4`ï¼Œä¾ç„¶æŠ¥é”™ã€‚

æœ€åæ’æŸ¥åˆ°, åŸæ¥Connector/Jä½¿ç”¨ç¼–ç æ ¼å¼æ˜¯serveré…ç½®çš„ `character_set_server` æŒ‡å®šçš„å­—ç¬¦é›†ã€‚
+  Connector/Jå®˜æ–¹æ–‡æ¡£è¯´æ˜:  [https://dev.mysql.com/doc/relnotes/connector-j/5.1/en/news-5-1-13.html#connector-j-5-1-13-bug](https://dev.mysql.com/doc/relnotes/connector-j/5.1/en/news-5-1-13.html#connector-j-5-1-13-bug)

ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡å‘¢ï¼Ÿæœ‰ä»€ä¹ˆå†å²é—ç•™é—®é¢˜ï¼Ÿè¿™å—ä¸æ˜¯å¤ªäº†è§£ï¼Œä¹Ÿä¸æ˜¯å¾ˆèƒ½ç†è§£ã€‚

## é—®é¢˜è§£å†³
å…¶å®åªè¦åœ¨javaç¨‹åºä¸­ï¼ŒæŒ‡å®šè¿æ¥ä½¿ç”¨çš„å­—ç¬¦é›†ç¼–ç ä¸ºutfmb4å³å¯ï¼Œå³

```java
String query = "set names utf8mb4";
stat.execute(query);
```
å› ä¸ºä½¿ç”¨çš„æ˜¯druidæ•°æ®æºæ¥ç®¡ç†è¿æ¥æ± ï¼Œè€Œdruidæä¾›`connection-init-sqls`å‚æ•°æ¥åˆ¶å®šconnectionåœ¨initæ—¶éœ€è¦æ‰§è¡Œçš„sqlï¼Œæ‰€ä»¥å¢åŠ é…ç½®
```
-- Spring Bootå¢åŠ é…ç½®
spring.datasource.druid.connection-init-sqls=set names utf8mb4;

-- SpringMVC
<bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource" init-method="init" destroy-method="close">
    <!-- å‰é¢çš„urlï¼Œidleï¼Œactiveç­‰ç­‰é…ç½®çœç•¥ -->
    <property name="connectionInitSqls" value="SET NAMES utf8mb4;"/>
</bean>
```

## ç›¸å…³çŸ¥è¯†ç‚¹
### å­—ç¬¦é›†å’Œå­—ç¬¦åº
å­—ç¬¦é›†å®šä¹‰äº†å­—ç¬¦ä»¥åŠå­—ç¬¦çš„ç¼–ç ï¼Œè€Œå­—ç¬¦åºåˆ—åˆ™å®šä¹‰äº†å­—ç¬¦çš„æ¯”è¾ƒè§„åˆ™ã€‚æ‰€ä»¥ä¸€ä¸ªå­—ç¬¦é›†å¯ä»¥å¯¹åº”å¤šç§å­—ç¬¦åºã€‚

é€šè¿‡ `SHOW CHARACTER SET` å‘½ä»¤å¯ä»¥æŸ¥çœ‹MySQLæ”¯æŒçš„å­—ç¬¦é›†ï¼Œä»¥åŠå¯¹è¯¥å­—ç¬¦é›†é»˜è®¤çš„å­—ç¬¦åºï¼Œè¯¥å­—ç¬¦æ‰€å é•¿åº¦ç­‰ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯MySQL5.7.24æ‰€æ”¯æŒçš„å­—ç¬¦é›†çš„éƒ¨åˆ†å†…å®¹ã€‚
```
Charset     Description                     Default_Collation   Maxlen
big5        Big5 Traditional Chinese        big5_chinese_ci     2
utf8        UTF-8 Unicode                   utf8_general_ci     3
utf8mb4     UTF-8 Unicode                   utf8mb4_general_ci  4
utf32       UTF-32 Unicode                  utf32_general_ci    4
binary      Binary  pseudo charset          binary              1
geostd8     GEOSTD8 Georgian                geostd8_general_ci  1
gb18030     China National Standard GB18030 gb18030_chinese_ci  4
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­utf8å 3ä¸ªå­—èŠ‚ï¼Œutf8mb4å 4ä¸ªå­—èŠ‚ã€‚utf8é»˜è®¤çš„å­—ç¬¦åºæ˜¯`utf8_general_ci`,utf8mb4é»˜è®¤çš„å­—ç¬¦åºæ˜¯ `utf8mb4_general_ci` ã€‚

### utf8å’Œutf8mb4
MySQLåœ¨5.5.3ä¹‹åå¢åŠ äº†utfmb4å­—ç¬¦é›†ï¼Œ`mb4`çš„æ„æ€æ˜¯`most bytes 4`ï¼ŒåŸå…ˆçš„utf8åªæœ‰ä¸‰ä¸ªå­—èŠ‚ï¼Œä¸èƒ½å­˜å‚¨ä¸€äº›ç”Ÿåƒ»æ±‰å­—å’Œemojiç¬¦å·ï¼Œä¾‹å¦‚:ğŸš— ğŸ˜Š ğŸŸ ç­‰ç­‰ã€‚utf8mb4å°±æ˜¯ç”¨æ¥å…¼å®¹çš„4ä¸ªå­—èŠ‚çš„unicode,utf8mb4æ˜¯utf8çš„è¶…é›†ã€‚æ‰€ä»¥å¯ä»¥ç”¨ç±»ä¼¼ `alter table table_name convert to character set utf8mb4` è¿™æ ·çš„è¯­å¥ï¼Œå°†tableçš„å­—ç¬¦é›†è½¬ä¸ºutf8mb4ã€‚

+ å…³äºutf8mb4çš„å®˜æ–¹æ–‡æ¡£è¯´æ˜: [https://dev.mysql.com/doc/refman/5.7/en/charset-unicode-utf8mb4.html](https://dev.mysql.com/doc/refman/5.7/en/charset-unicode-utf8mb4.html)
